# Grafana configuration for local development
# Chart version: 8.12.1, Grafana 11.6.0

replicas: 1

# Admin credentials
adminUser: admin
adminPassword: admin

# Disable secret leak validation for local development
assertNoLeakedSecrets: false

# Service configuration
service:
  type: NodePort
  nodePort: 30080
  port: 80
  targetPort: 3000

# Persistence
persistence:
  enabled: true
  type: pvc
  storageClassName: standard
  size: 5Gi

# Resources
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Datasources
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    # Mimir datasource for metrics (Prometheus-compatible)
    - name: Mimir
      type: prometheus
      uid: mimir
      url: http://mimir-query-frontend.mimir.svc.cluster.local:8080/prometheus
      access: proxy
      isDefault: false
      jsonData:
        timeInterval: 30s
        queryTimeout: 60s
      editable: true

    # Loki datasource for logs
    - name: Loki
      type: loki
      uid: loki
      url: http://loki-gateway.loki.svc.cluster.local
      access: proxy
      isDefault: true
      jsonData:
        maxLines: 1000
        httpHeaderName1: "X-Scope-OrgID"
        derivedFields:
          - datasourceUid: tempo
            matcherRegex: "traceid\":\"(\\w+)"
            name: TraceID
            url: "$${__value.raw}"
      secureJsonData:
        httpHeaderValue1: "tenant1"
      editable: true

    # Tempo datasource for traces
    - name: Tempo
      type: tempo
      uid: tempo
      url: http://tempo.tempo.svc.cluster.local:3100
      access: proxy
      jsonData:
        tracesToLogsV2:
          datasourceUid: loki
          spanStartTimeShift: '-1h'
          spanEndTimeShift: '1h'
          filterByTraceID: true
          filterBySpanID: false
          customQuery: true
          query: '{service_name="$${__span.tags["service.name"]}"} | json | trace_id="$${__span.traceId}"'
        tracesToMetrics:
          datasourceUid: mimir
          spanStartTimeShift: '-1h'
          spanEndTimeShift: '1h'
          tags:
            - key: service.name
              value: service_name
        serviceMap:
          datasourceUid: mimir
        nodeGraph:
          enabled: true
        search:
          hide: false
        lokiSearch:
          datasourceUid: loki
      editable: true

# Dashboards
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /var/lib/grafana/dashboards/default

dashboards:
  default:
    # Loki dashboard
    loki-dashboard:
      gnetId: 13639
      revision: 2
      datasource: Loki

    # Tempo dashboard
    tempo-dashboard:
      gnetId: 16795
      revision: 3
      datasource: Tempo

# Plugins
plugins:
  - grafana-clock-panel
  - grafana-piechart-panel

# Grafana configuration
grafana.ini:
  server:
    root_url: http://localhost:3000

  analytics:
    reporting_enabled: false
    check_for_updates: false

  security:
    allow_embedding: true

  users:
    default_theme: dark
    auto_assign_org: true
    auto_assign_org_role: Editor

  auth.anonymous:
    enabled: false

  log:
    mode: console
    level: info

  alerting:
    enabled: false

  unified_alerting:
    enabled: true

# RBAC
rbac:
  create: true

# Service account
serviceAccount:
  create: true
  name: grafana

# Environment variables
env:
  GF_EXPLORE_ENABLED: "true"
  GF_UNIFIED_ALERTING_ENABLED: "true"

# Service monitor (disabled for local dev)
serviceMonitor:
  enabled: false

# Ingress (disabled - using NodePort)
ingress:
  enabled: false

# Sidecar for dynamic dashboard loading
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    folder: /tmp/dashboards
    defaultFolderName: General
    searchNamespace: ALL

  datasources:
    enabled: false
