{
  "name": "multi-region-resilient-observability",
  "description": "Multi-region, multi-account deployment with shared services and workloads",
  "defaultRegion": "us-east-1",
  "defaultTags": {
    "Project": "resilient-observability",
    "Environment": "production",
    "ManagedBy": "pulumi"
  },
  "stacks": [
    {
      "name": "shared-services-primary",
      "workDir": "./shared-services",
      "stackName": "shared-services-primary",
      "configFile": "Pulumi.shared-services-primary.yaml",
      "description": "Shared services in primary region (us-east-1)",
      "roleArn": "${SHARED_SERVICES_ROLE_ARN}",
      "components": [
        {
          "type": "ipam",
          "name": "primary-ipam",
          "config": {
            "region": "us-east-1",
            "ipamCidrBlocks": ["10.0.0.0/8"],
            "ipamOperatingRegions": ["us-east-1", "us-west-2"],
            "ipamRegionalPoolNetmask": 12,
            "ipamVpcAllocationNetmask": 16
          }
        },
        {
          "type": "transit-gateway",
          "name": "primary-tgw",
          "config": {
            "region": "us-east-1",
            "asn": 64512,
            "enableRouteTableIsolation": true,
            "routingGroups": {
              "production": {
                "description": "Production workloads",
                "allowedGroups": [],
                "tags": {
                  "Environment": "Production",
                  "Criticality": "Critical"
                }
              }
            }
          },
          "notes": "To add more routing groups (dev, test, staging), add them to routingGroups. Hub is automatic. Example: 'development': { 'allowedGroups': ['test'] }"
        },
        {
          "type": "hub-vpc",
          "name": "primary-hub-vpc",
          "config": {
            "region": "us-east-1",
            "cidrBlock": "10.0.0.0/16"
          }
        },
        {
          "type": "shared-eks",
          "name": "primary-shared-eks",
          "config": {
            "region": "us-east-1",
            "clusterName": "shared-monitoring-cluster"
          }
        }
      ],
      "tags": {
        "Region": "us-east-1",
        "AccountType": "shared-services",
        "IsPrimary": "true"
      }
    },
    {
      "name": "shared-services-secondary",
      "workDir": "./shared-services",
      "stackName": "shared-services-secondary",
      "configFile": "Pulumi.shared-services-secondary.yaml",
      "description": "Shared services in secondary region (us-west-2)",
      "dependencies": ["shared-services-primary"],
      "roleArn": "${SHARED_SERVICES_ROLE_ARN}",
      "components": [
        {
          "type": "transit-gateway",
          "name": "secondary-tgw",
          "config": {
            "region": "us-west-2",
            "asn": 64513,
            "enableRouteTableIsolation": true,
            "routingGroups": {
              "production": {
                "description": "Production workloads",
                "allowedGroups": [],
                "tags": {
                  "Environment": "Production",
                  "Criticality": "Critical"
                }
              }
            }
          },
          "notes": "To add more routing groups (dev, test, staging), add them to routingGroups. Hub is automatic. Example: 'development': { 'allowedGroups': ['test'] }"
        },
        {
          "type": "hub-vpc",
          "name": "secondary-hub-vpc",
          "config": {
            "region": "us-west-2",
            "cidrBlock": "10.2.0.0/16"
          }
        },
        {
          "type": "shared-eks",
          "name": "secondary-shared-eks",
          "config": {
            "region": "us-west-2",
            "clusterName": "shared-monitoring-cluster-secondary"
          }
        }
      ],
      "tags": {
        "Region": "us-west-2",
        "AccountType": "shared-services",
        "IsPrimary": "false"
      }
    },
    {
      "name": "workloads-primary",
      "workDir": "./workloads",
      "stackName": "workloads-primary",
      "configFile": "Pulumi.workloads-primary.yaml",
      "description": "Workloads in primary region (us-east-1)",
      "dependencies": ["shared-services-primary"],
      "roleArn": "${WORKLOADS_ROLE_ARN}",
      "components": [
        {
          "type": "spoke-vpc",
          "name": "primary-spoke-vpc",
          "config": {
            "region": "us-east-1",
            "cidrBlock": "10.1.0.0/16",
            "routingGroup": "production"
          }
        },
        {
          "type": "workload-eks",
          "name": "primary-workload-eks",
          "config": {
            "region": "us-east-1",
            "clusterName": "workload-cluster"
          }
        },
        {
          "type": "rds-global",
          "name": "primary-rds-global",
          "config": {
            "region": "us-east-1",
            "globalClusterIdentifier": "workload-global-db",
            "isPrimary": true
          }
        },
        {
          "type": "route53",
          "name": "route53-failover",
          "config": {
            "hostedZone": "workloads.example.com"
          }
        }
      ],
      "tags": {
        "Region": "us-east-1",
        "AccountType": "workloads",
        "IsPrimary": "true"
      }
    },
    {
      "name": "workloads-secondary",
      "workDir": "./workloads",
      "stackName": "workloads-secondary",
      "configFile": "Pulumi.workloads-secondary.yaml",
      "description": "Workloads in secondary region (us-west-2)",
      "dependencies": ["shared-services-secondary", "workloads-primary"],
      "roleArn": "${WORKLOADS_ROLE_ARN}",
      "components": [
        {
          "type": "spoke-vpc",
          "name": "secondary-spoke-vpc",
          "config": {
            "region": "us-west-2",
            "cidrBlock": "10.3.0.0/16",
            "routingGroup": "production"
          }
        },
        {
          "type": "workload-eks",
          "name": "secondary-workload-eks",
          "config": {
            "region": "us-west-2",
            "clusterName": "workload-cluster-secondary"
          }
        },
        {
          "type": "rds-global",
          "name": "secondary-rds-global",
          "config": {
            "region": "us-west-2",
            "globalClusterIdentifier": "workload-global-db",
            "isPrimary": false
          }
        }
      ],
      "tags": {
        "Region": "us-west-2",
        "AccountType": "workloads",
        "IsPrimary": "false"
      }
    }
  ],

  "deploymentOptions": {
    "parallel": false,
    "continueOnFailure": false,
    "rollbackOnFailure": true,
    "refresh": true
  }
}