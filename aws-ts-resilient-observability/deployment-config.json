{
  "name": "multi-region-resilient-observability",
  "description": "Multi-region, multi-account deployment with shared services and workloads",
  "defaultRegion": "us-east-1",
  "defaultTags": {
    "Project": "resilient-observability",
    "Environment": "production",
    "ManagedBy": "pulumi"
  },
  "stacks": [
    {
      "name": "shared-services-primary",
      "workDir": "./shared-services",
      "stackName": "shared-services-primary",
      "configFile": "Pulumi.shared-services-primary.yaml",
      "description": "Shared services in primary region (us-east-1)",
      "roleArn": "${SHARED_SERVICES_ROLE_ARN}",
      "components": [
        {
          "type": "ipam",
          "name": "primary-ipam",
          "config": {
            "region": "us-east-1",
            "ipamCidrBlocks": ["10.0.0.0/8"],
            "ipamOperatingRegions": ["us-east-1", "us-west-2"],
            "ipamRegionalPoolNetmask": 12,
            "ipamVpcAllocationNetmask": 16
          }
        },
        {
          "type": "transit-gateway",
          "name": "primary-tgw",
          "config": {
            "region": "us-east-1",
            "asn": 64512,
            "enableRouteTableIsolation": true,
            "routingGroups": {
              "production": {
                "description": "Production workloads",
                "allowedGroups": [],
                "tags": {
                  "Environment": "Production",
                  "Criticality": "Critical"
                }
              }
            }
          },
          "notes": "To add more routing groups (dev, test, staging), add them to routingGroups. Hub is automatic. Example: 'development': { 'allowedGroups': ['test'] }"
        },
        {
          "type": "hub-vpc",
          "name": "primary-hub-vpc",
          "config": {
            "region": "us-east-1"
          },
          "notes": "CIDR automatically allocated from IPAM pool (10.0.0.0/8) with /16 netmask"
        },
        {
          "type": "shared-eks",
          "name": "primary-shared-eks",
          "config": {
            "region": "us-east-1",
            "clusterName": "shared-monitoring-cluster"
          }
        },
        {
          "type": "dns",
          "name": "primary-dns",
          "config": {
            "region": "us-east-1",
            "baseDomain": "internal.srelog.dev",
            "parentDomain": "srelog.dev",
            "enableCertificates": true,
            "certificateValidationMethod": "namecheap"
          },
          "notes": "Creates private Route53 zone and ACM certificate. Requires Namecheap credentials in Pulumi ESC environment 'namecheap-credentials'"
        },
        {
          "type": "cloudflare-tunnel",
          "name": "primary-cloudflare-tunnel",
          "config": {
            "region": "us-east-1",
            "enableCloudflareTunnel": true,
            "cloudflareTunnelReplicas": 2
          },
          "notes": "Deploys cloudflared to provide secure access via WARP. Requires cloudflareTunnelToken in Pulumi ESC"
        },
        {
          "type": "observability",
          "name": "primary-observability",
          "config": {
            "region": "us-east-1",
            "enableObservability": true,
            "loki": {
              "enabled": true
            },
            "tempo": {
              "enabled": true
            },
            "mimir": {
              "enabled": true
            },
            "grafana": {
              "enabled": true
            },
            "otelCollector": {
              "enabled": true
            }
          },
          "notes": "Deploys full observability stack: Loki (logs), Tempo (traces), Mimir (metrics), Grafana, and OTel Collector"
        }
      ],
      "tags": {
        "Region": "us-east-1",
        "AccountType": "shared-services",
        "IsPrimary": "true"
      }
    },
    {
      "name": "shared-services-secondary",
      "workDir": "./shared-services",
      "stackName": "shared-services-secondary",
      "configFile": "Pulumi.shared-services-secondary.yaml",
      "description": "Shared services in secondary region (us-west-2)",
      "dependencies": ["shared-services-primary"],
      "roleArn": "${SHARED_SERVICES_ROLE_ARN}",
      "components": [
        {
          "type": "transit-gateway",
          "name": "secondary-tgw",
          "config": {
            "region": "us-west-2",
            "asn": 64513,
            "enableRouteTableIsolation": true,
            "routingGroups": {
              "production": {
                "description": "Production workloads",
                "allowedGroups": [],
                "tags": {
                  "Environment": "Production",
                  "Criticality": "Critical"
                }
              }
            }
          },
          "notes": "To add more routing groups (dev, test, staging), add them to routingGroups. Hub is automatic. Example: 'development': { 'allowedGroups': ['test'] }"
        },
        {
          "type": "hub-vpc",
          "name": "secondary-hub-vpc",
          "config": {
            "region": "us-west-2"
          },
          "notes": "CIDR automatically allocated from IPAM pool (10.0.0.0/8) with /16 netmask"
        },
        {
          "type": "shared-eks",
          "name": "secondary-shared-eks",
          "config": {
            "region": "us-west-2",
            "clusterName": "shared-monitoring-cluster-secondary"
          }
        },
        {
          "type": "dns",
          "name": "secondary-dns",
          "config": {
            "region": "us-west-2",
            "baseDomain": "internal.srelog.dev",
            "parentDomain": "srelog.dev",
            "enableCertificates": true,
            "certificateValidationMethod": "namecheap"
          },
          "notes": "Creates private Route53 zone and ACM certificate. Requires Namecheap credentials in Pulumi ESC environment 'namecheap-credentials'"
        },
        {
          "type": "cloudflare-tunnel",
          "name": "secondary-cloudflare-tunnel",
          "config": {
            "region": "us-west-2",
            "enableCloudflareTunnel": true,
            "cloudflareTunnelReplicas": 2
          },
          "notes": "Deploys cloudflared to provide secure access via WARP. Uses same tunnel token as primary for multi-region redundancy"
        },
        {
          "type": "observability",
          "name": "secondary-observability",
          "config": {
            "region": "us-west-2",
            "enableObservability": true,
            "loki": {
              "enabled": true
            },
            "tempo": {
              "enabled": true
            },
            "mimir": {
              "enabled": true
            },
            "grafana": {
              "enabled": true
            },
            "otelCollector": {
              "enabled": true
            }
          },
          "notes": "Deploys full observability stack: Loki (logs), Tempo (traces), Mimir (metrics), Grafana, and OTel Collector"
        }
      ],
      "tags": {
        "Region": "us-west-2",
        "AccountType": "shared-services",
        "IsPrimary": "false"
      }
    },
    {
      "name": "workloads-primary",
      "workDir": "./workloads",
      "stackName": "workloads-primary",
      "configFile": "Pulumi.workloads-primary.yaml",
      "description": "Workloads in primary region (us-east-1)",
      "dependencies": ["shared-services-primary"],
      "roleArn": "${WORKLOADS_ROLE_ARN}",
      "components": [
        {
          "type": "spoke-vpc",
          "name": "primary-spoke-vpc",
          "config": {
            "region": "us-east-1",
            "routingGroup": "production"
          },
          "notes": "CIDR automatically allocated from IPAM pool (10.0.0.0/8) with /16 netmask"
        },
        {
          "type": "workload-eks",
          "name": "primary-workload-eks",
          "config": {
            "region": "us-east-1",
            "clusterName": "workload-cluster"
          }
        },
        {
          "type": "rds-global",
          "name": "primary-rds-global",
          "config": {
            "region": "us-east-1",
            "globalClusterIdentifier": "workload-global-db",
            "isPrimary": true
          }
        },
        {
          "type": "route53",
          "name": "route53-failover",
          "config": {
            "hostedZone": "workloads.example.com"
          }
        },
        {
          "type": "observability-agent",
          "name": "primary-observability-agent",
          "config": {
            "region": "us-east-1",
            "enableOTelAgent": true,
            "otelCollectorReplicas": 2
          },
          "notes": "Deploys OTel Collector agents in workload cluster to send telemetry to shared-services observability stack"
        }
      ],
      "tags": {
        "Region": "us-east-1",
        "AccountType": "workloads",
        "IsPrimary": "true"
      }
    },
    {
      "name": "workloads-secondary",
      "workDir": "./workloads",
      "stackName": "workloads-secondary",
      "configFile": "Pulumi.workloads-secondary.yaml",
      "description": "Workloads in secondary region (us-west-2)",
      "dependencies": ["shared-services-secondary", "workloads-primary"],
      "roleArn": "${WORKLOADS_ROLE_ARN}",
      "components": [
        {
          "type": "spoke-vpc",
          "name": "secondary-spoke-vpc",
          "config": {
            "region": "us-west-2",
            "routingGroup": "production"
          },
          "notes": "CIDR automatically allocated from IPAM pool (10.0.0.0/8) with /16 netmask"
        },
        {
          "type": "workload-eks",
          "name": "secondary-workload-eks",
          "config": {
            "region": "us-west-2",
            "clusterName": "workload-cluster-secondary"
          }
        },
        {
          "type": "rds-global",
          "name": "secondary-rds-global",
          "config": {
            "region": "us-west-2",
            "globalClusterIdentifier": "workload-global-db",
            "isPrimary": false
          }
        },
        {
          "type": "observability-agent",
          "name": "secondary-observability-agent",
          "config": {
            "region": "us-west-2",
            "enableOTelAgent": true,
            "otelCollectorReplicas": 2
          },
          "notes": "Deploys OTel Collector agents in workload cluster to send telemetry to shared-services observability stack"
        }
      ],
      "tags": {
        "Region": "us-west-2",
        "AccountType": "workloads",
        "IsPrimary": "false"
      }
    }
  ],

  "deploymentOptions": {
    "parallel": false,
    "continueOnFailure": false,
    "rollbackOnFailure": true,
    "refresh": true
  }
}